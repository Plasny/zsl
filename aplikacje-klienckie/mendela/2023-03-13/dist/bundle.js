(()=>{"use strict";var t=new Map,i=["blue","red","yellow"];function e(){return i.unshift(i.pop()),[{spriteName:"microbe_".concat(i[0],"_big"),pos:{x:80,y:304}},{spriteName:"microbe_".concat(i[1],"_big"),pos:{x:112,y:240}},{spriteName:"microbe_".concat(i[2],"_big"),pos:{x:48,y:240}}]}var s,o=function(t,i,e,s){return new(e||(e=Promise))((function(o,l){function n(t){try{r(s.next(t))}catch(t){l(t)}}function p(t){try{r(s.throw(t))}catch(t){l(t)}}function r(t){var i;t.done?o(t.value):(i=t.value,i instanceof e?i:new e((function(t){t(i)}))).then(n,p)}r((s=s.apply(t,i||[])).next())}))},l=function(t,i){var e,s,o,l,n={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return l={next:p(0),throw:p(1),return:p(2)},"function"==typeof Symbol&&(l[Symbol.iterator]=function(){return this}),l;function p(p){return function(r){return function(p){if(e)throw new TypeError("Generator is already executing.");for(;l&&(l=0,p[0]&&(n=0)),n;)try{if(e=1,s&&(o=2&p[0]?s.return:p[0]?s.throw||((o=s.return)&&o.call(s),0):s.next)&&!(o=o.call(s,p[1])).done)return o;switch(s=0,o&&(p=[2&p[0],o.value]),p[0]){case 0:case 1:o=p;break;case 4:return n.label++,{value:p[1],done:!1};case 5:n.label++,s=p[1],p=[0];continue;case 7:p=n.ops.pop(),n.trys.pop();continue;default:if(!((o=(o=n.trys).length>0&&o[o.length-1])||6!==p[0]&&2!==p[0])){n=0;continue}if(3===p[0]&&(!o||p[1]>o[0]&&p[1]<o[3])){n.label=p[1];break}if(6===p[0]&&n.label<o[1]){n.label=o[1],o=p;break}if(o&&n.label<o[2]){n.label=o[2],n.ops.push(p);break}o[2]&&n.ops.pop(),n.trys.pop();continue}p=i.call(t,n)}catch(t){p=[6,t],s=0}finally{e=o=0}if(5&p[0])throw p[1];return{value:p[0]?p[1]:void 0,done:!0}}([p,r])}}},n=function(t,i,e){if(e||2===arguments.length)for(var s,o=0,l=i.length;o<l;o++)!s&&o in i||(s||(s=Array.prototype.slice.call(i,0,o)),s[o]=i[o]);return t.concat(s||Array.prototype.slice.call(i))},p=function(){function t(t,i){var s;this.canvW=640,this.canvH=384,this.currentFrame=0,this.topScore=0,this.score=0,this.sizeUnit=16,this.microbesLeft=4,this.throwAnimationTime=0,this.toDestroy=[],this.toDraw=e(),this.ok=!1,this.width=t,this.height=i;var o=null!==(s=document.getElementById("game"))&&void 0!==s?s:document.body;o.innerHTML="";var l=document.createElement("canvas");l.width=this.canvW,l.height=this.canvH,l.id="board",this.ctx=l.getContext("2d"),this.loadJson(),this.loadSprites(),o.append(l)}return t.prototype.loadSprites=function(){return o(this,void 0,void 0,(function(){return l(this,(function(t){switch(t.label){case 0:return this.spritesheet=new Image,this.spritesheet.src="./res/sprites.png",[4,this.spritesheet.decode()];case 1:return t.sent(),this.ok=!0,[2]}}))}))},t.prototype.loadJson=function(){return o(this,void 0,void 0,(function(){var t;return l(this,(function(i){switch(i.label){case 0:return t=this,[4,fetch("./res/animations.json").then((function(t){return t.json()}))];case 1:return t.json=i.sent(),[2]}}))}))},t.prototype.preparePill=function(t){this.nextColors=t},t.prototype.animateThrow=function(){if(24===this.throwAnimationTime)return this.throwAnimationTime=0,!0;for(var t=0,i=function(t){return[[{spriteName:"pill_".concat(t[0],"_3"),pos:{x:480,y:48}},{spriteName:"pill_".concat(t[1],"_4"),pos:{x:496,y:48}},{spriteName:"hand_up_p1",pos:{x:496,y:64}},{spriteName:"hand_up_p2",pos:{x:496,y:80}},{spriteName:"hand_up_p3",pos:{x:496,y:96}}],[{spriteName:"pill_".concat(t[0],"_2"),pos:{x:480,y:48}},{spriteName:"pill_".concat(t[1],"_1"),pos:{x:480,y:32}},{spriteName:"hand_up_p1",pos:{x:496,y:64}},{spriteName:"hand_up_p2",pos:{x:496,y:80}},{spriteName:"hand_up_p3",pos:{x:496,y:96}}],[{spriteName:"pill_".concat(t[0],"_4"),pos:{x:480,y:32}},{spriteName:"pill_".concat(t[1],"_3"),pos:{x:464,y:32}},{spriteName:"hand_up_p1",pos:{x:496,y:64}},{spriteName:"hand_up_p2",pos:{x:496,y:80}},{spriteName:"hand_up_p3",pos:{x:496,y:96}}],[{spriteName:"pill_".concat(t[1],"_2"),pos:{x:464,y:32}},{spriteName:"pill_".concat(t[0],"_1"),pos:{x:464,y:16}},{spriteName:"hand_up_p1",pos:{x:496,y:64}},{spriteName:"hand_up_p2",pos:{x:496,y:80}},{spriteName:"hand_up_p3",pos:{x:496,y:96}}],[{spriteName:"pill_".concat(t[1],"_4"),pos:{x:464,y:16}},{spriteName:"pill_".concat(t[0],"_3"),pos:{x:448,y:16}},{spriteName:"hand_middle_p1",pos:{x:480,y:80}},{spriteName:"hand_middle_p2",pos:{x:496,y:80}},{spriteName:"hand_middle_p3",pos:{x:480,y:96}},{spriteName:"hand_middle_p4",pos:{x:496,y:96}}],[{spriteName:"pill_".concat(t[0],"_2"),pos:{x:448,y:16}},{spriteName:"pill_".concat(t[1],"_1"),pos:{x:448,y:0}},{spriteName:"hand_middle_p1",pos:{x:480,y:80}},{spriteName:"hand_middle_p2",pos:{x:496,y:80}},{spriteName:"hand_middle_p3",pos:{x:480,y:96}},{spriteName:"hand_middle_p4",pos:{x:496,y:96}}],[{spriteName:"pill_".concat(t[0],"_4"),pos:{x:448,y:16}},{spriteName:"pill_".concat(t[1],"_3"),pos:{x:432,y:16}},{spriteName:"hand_middle_p1",pos:{x:480,y:80}},{spriteName:"hand_middle_p2",pos:{x:496,y:80}},{spriteName:"hand_middle_p3",pos:{x:480,y:96}},{spriteName:"hand_middle_p4",pos:{x:496,y:96}}],[{spriteName:"pill_".concat(t[1],"_2"),pos:{x:432,y:16}},{spriteName:"pill_".concat(t[0],"_1"),pos:{x:432,y:0}},{spriteName:"hand_down_p1",pos:{x:496,y:96}},{spriteName:"hand_down_p2",pos:{x:496,y:112}}],[{spriteName:"pill_".concat(t[1],"_4"),pos:{x:432,y:16}},{spriteName:"pill_".concat(t[0],"_3"),pos:{x:416,y:16}},{spriteName:"hand_down_p1",pos:{x:496,y:96}},{spriteName:"hand_down_p2",pos:{x:496,y:112}}],[{spriteName:"pill_".concat(t[0],"_2"),pos:{x:416,y:16}},{spriteName:"pill_".concat(t[1],"_1"),pos:{x:416,y:0}},{spriteName:"hand_down_p1",pos:{x:496,y:96}},{spriteName:"hand_down_p2",pos:{x:496,y:112}}],[{spriteName:"pill_".concat(t[0],"_4"),pos:{x:416,y:16}},{spriteName:"pill_".concat(t[1],"_3"),pos:{x:400,y:16}},{spriteName:"hand_down_p1",pos:{x:496,y:96}},{spriteName:"hand_down_p2",pos:{x:496,y:112}}],[{spriteName:"pill_".concat(t[1],"_2"),pos:{x:400,y:16}},{spriteName:"pill_".concat(t[0],"_1"),pos:{x:400,y:0}},{spriteName:"hand_down_p1",pos:{x:496,y:96}},{spriteName:"hand_down_p2",pos:{x:496,y:112}}],[{spriteName:"pill_".concat(t[1],"_4"),pos:{x:400,y:16}},{spriteName:"pill_".concat(t[0],"_3"),pos:{x:384,y:16}},{spriteName:"hand_down_p1",pos:{x:496,y:96}},{spriteName:"hand_down_p2",pos:{x:496,y:112}}],[{spriteName:"pill_".concat(t[0],"_2"),pos:{x:384,y:16}},{spriteName:"pill_".concat(t[1],"_1"),pos:{x:384,y:0}},{spriteName:"hand_down_p1",pos:{x:496,y:96}},{spriteName:"hand_down_p2",pos:{x:496,y:112}}],[{spriteName:"pill_".concat(t[0],"_4"),pos:{x:384,y:16}},{spriteName:"pill_".concat(t[1],"_3"),pos:{x:368,y:16}},{spriteName:"hand_down_p1",pos:{x:496,y:96}},{spriteName:"hand_down_p2",pos:{x:496,y:112}}],[{spriteName:"pill_".concat(t[1],"_2"),pos:{x:368,y:16}},{spriteName:"pill_".concat(t[0],"_1"),pos:{x:368,y:0}},{spriteName:"hand_down_p1",pos:{x:496,y:96}},{spriteName:"hand_down_p2",pos:{x:496,y:112}}],[{spriteName:"pill_".concat(t[1],"_4"),pos:{x:368,y:16}},{spriteName:"pill_".concat(t[0],"_3"),pos:{x:352,y:16}},{spriteName:"hand_down_p1",pos:{x:496,y:96}},{spriteName:"hand_down_p2",pos:{x:496,y:112}}],[{spriteName:"pill_".concat(t[0],"_2"),pos:{x:352,y:16}},{spriteName:"pill_".concat(t[1],"_1"),pos:{x:352,y:0}},{spriteName:"hand_down_p1",pos:{x:496,y:96}},{spriteName:"hand_down_p2",pos:{x:496,y:112}}],[{spriteName:"pill_".concat(t[0],"_4"),pos:{x:352,y:32}},{spriteName:"pill_".concat(t[1],"_3"),pos:{x:336,y:32}},{spriteName:"hand_down_p1",pos:{x:496,y:96}},{spriteName:"hand_down_p2",pos:{x:496,y:112}}],[{spriteName:"pill_".concat(t[1],"_2"),pos:{x:336,y:48}},{spriteName:"pill_".concat(t[0],"_1"),pos:{x:336,y:32}},{spriteName:"hand_down_p1",pos:{x:496,y:96}},{spriteName:"hand_down_p2",pos:{x:496,y:112}}],[{spriteName:"pill_".concat(t[1],"_4"),pos:{x:336,y:48}},{spriteName:"pill_".concat(t[0],"_3"),pos:{x:320,y:48}},{spriteName:"hand_down_p1",pos:{x:496,y:96}},{spriteName:"hand_down_p2",pos:{x:496,y:112}}],[{spriteName:"pill_".concat(t[1],"_4"),pos:{x:336,y:64}},{spriteName:"pill_".concat(t[0],"_3"),pos:{x:320,y:64}},{spriteName:"hand_down_p1",pos:{x:496,y:96}},{spriteName:"hand_down_p2",pos:{x:496,y:112}}],[{spriteName:"pill_".concat(t[1],"_4"),pos:{x:336,y:80}},{spriteName:"pill_".concat(t[0],"_3"),pos:{x:320,y:80}},{spriteName:"hand_down_p1",pos:{x:496,y:96}},{spriteName:"hand_down_p2",pos:{x:496,y:112}}],[{spriteName:"pill_".concat(t[1],"_4"),pos:{x:336,y:96}},{spriteName:"pill_".concat(t[0],"_3"),pos:{x:320,y:96}},{spriteName:"hand_down_p1",pos:{x:496,y:96}},{spriteName:"hand_down_p2",pos:{x:496,y:112}}]]}(this.nextColors)[this.throwAnimationTime];t<i.length;t++){var e=i[t];this.drawFrame(e.spriteName,e.pos.x,e.pos.y)}return this.throwAnimationTime++,!1},t.prototype.setTopScore=function(t){this.topScore=t},t.prototype.setScore=function(t){this.score=t},t.prototype.setMicrobesLeft=function(t){this.microbesLeft=t},t.prototype.getFrame=function(t){if(!this.json)return[0,0,0,0];var i=this.currentFrame%this.json.sprites[t].framesNr;return Object.values(this.json.sprites[t].frames[i])},t.prototype.getSize=function(t){return this.json?[this.json.sprites[t].size.w,this.json.sprites[t].size.h]:[0,0]},t.prototype.drawFrame=function(t,i,e){var s;(s=this.ctx).drawImage.apply(s,n(n(n([this.spritesheet],this.getFrame(t),!1),[i,e],!1),this.getSize(t),!1))},t.prototype.drawText=function(t,i,e,s){var o,l,p;l=t.toString().split(""),p=new Array(i);for(var r=0;r<l.length;r++)p[i-l.length+r]=l[r];for(p.fill("0",0,i-l.length),r=0;r<i;r++)(o=this.ctx).drawImage.apply(o,n(n(n([this.spritesheet],this.getFrame(p[r]),!1),[(e+r)*this.sizeUnit,s*this.sizeUnit],!1),this.getSize(p[r]),!1))},t.prototype.gameOver=function(){var t=this.getSize("pop_gameOver"),i=t[0],e=t[1],s=(this.canvW-i)/2,o=(this.canvH-e)/2;this.drawFrame("pop_gameOver",s,o),this.drawFrame("dr_gameOver",480,48)},t.prototype.stageCleared=function(){var t=this.getSize("pop_stageCleared"),i=t[0],e=t[1],s=(this.canvW-i)/2,o=(this.canvH-e)/2;this.drawFrame("pop_stageCleared",s,o)},t.prototype.drawCell=function(t,i,e){var s=(17+e)*this.sizeUnit,o=(6+i)*this.sizeUnit;switch(t.cellType){case"movingPill":case"pill":this.drawFrame("pill_".concat(t.color,"_").concat(t.side),s,o);break;case"microbe":this.drawFrame("microbe_".concat(t.color),s,o)}},t.prototype.destroyPill=function(t,i,e){var s=(17+e)*this.sizeUnit,o=(6+i)*this.sizeUnit;void 0!==t&&this.toDestroy.push({sprite:"pill_".concat(t,"_pop"),x:s,y:o})},t.prototype.drawBoard=function(t){if(this.currentFrame++,this.drawFrame("bg",0,0),0!=this.toDestroy.length){for(var i=0,s=this.toDestroy;i<s.length;i++){var o=s[i];this.drawFrame(o.sprite,o.x,o.y)}this.toDestroy=[]}for(var l=0;l<this.height;l++)for(var n=0;n<this.width;n++)this.drawCell(t[l][n],l,n);this.currentFrame%5==0&&(this.toDraw=e());for(var p=0,r=this.toDraw;p<r.length;p++)o=r[p],this.drawFrame(o.spriteName,o.pos.x,o.pos.y);this.drawText(this.topScore,7,5,5),this.drawText(this.score,7,5,8),this.drawText(this.microbesLeft,2,35,21),0===this.throwAnimationTime&&(this.drawFrame("hand_up_p1",496,64),this.drawFrame("hand_up_p2",496,80),this.drawFrame("hand_up_p3",496,96),this.drawFrame("pill_".concat(this.nextColors[0],"_3"),480,48),this.drawFrame("pill_".concat(this.nextColors[1],"_4"),496,48))},t}();!function(t){t[t.All=0]="All",t[t.Top=1]="Top",t[t.Bottom=2]="Bottom",t[t.Left=3]="Left",t[t.Right=4]="Right"}(s||(s={}));var r=function(t,i,e){if(e||2===arguments.length)for(var s,o=0,l=i.length;o<l;o++)!s&&o in i||(s||(s=Array.prototype.slice.call(i,0,o)),s[o]=i[o]);return t.concat(s||Array.prototype.slice.call(i))},a=function(){function i(i,e,s,o){void 0===i&&(i=8),void 0===e&&(e=16),void 0===s&&(s=4),void 0===o&&(o=10);var l=this;this.types=["red","blue","yellow"],this.tick=0,this.score=0,this.pillNr=0,this.bestScore=0|JSON.parse(localStorage.getItem("bestScore")),this.noGame=!1,this.nextColors=["red","yellow"],this.width=i,this.height=e,this.microbesNr=s,this.tickLength=o,this.table=new Array;for(var n=0;n<this.height;n++)this.table.push(new Array(i).fill({cellType:"none"}));this.lastFrame=Date.now(),this.pillPosition=[],this.ui=new p(i,e),this.ui.setScore(this.score),this.ui.setTopScore(this.bestScore),this.ui.preparePill(this.nextColors),this.ui.drawBoard(this.table),this.randomMicrobes(this.microbesNr),this.preparePill(),this.Render=function(){if(l.animationFrame=requestAnimationFrame(l.Render),!1!==l.ui.ok&&!(l.lastFrame+1e3/l.tickLength>=Date.now())){if(l.lastFrame=Date.now(),l.tick++,l.checkForMaches(),l.dropAll(),l.ui.drawBoard(l.table),l.checkEndTheGame(),l.noGame){if(!l.ui.animateThrow())return;l.spawnPill(l.nextColors)}(l.tick%10==0||t.get("ArrowDown")||t.get("s"))&&l.dropPill(),l.movePill()}},this.Render(0)}return i.prototype.emptyCell=function(){return{cellType:"none"}},i.prototype.randomMicrobes=function(t){var i=["red","blue","yellow"];t:for(var e=0;e<t;e++){for(var s=Math.floor(Math.random()*this.width),o=Math.floor(Math.random()*this.height*2/3+this.height/3),l=Math.floor(Math.random()*i.length),n=0;n<this.width;n++)if("microbe"===this.table[o][n].cellType){e--;continue t}for(n=0;n<this.height;n++)if("microbe"===this.table[n][s].cellType){e--;continue t}this.table[o][s]={cellType:"microbe",color:i[l]},console.info("".concat(i[l]," microbe on ").concat(s,":").concat(o))}},i.prototype.preparePill=function(){for(var t=0;t<this.height;t++)for(var i=0;i<this.width;i++)"movingPill"===this.table[t][i].cellType&&(this.table[t][i].cellType="pill");this.pillPosition&&this.lastPillPosition&&this.lastPillPosition[0].y===this.pillPosition[0].y&&this.lastPillPosition[0].x===this.pillPosition[0].x&&(cancelAnimationFrame(this.animationFrame),this.ui.gameOver()),this.noGame=!0},i.prototype.spawnPill=function(t){this.pillPosition=[],this.pillPosition.push({y:0,x:3}),this.pillPosition.push({y:0,x:4});var i=++this.pillNr;this.table[0][3]={cellType:"movingPill",color:t[0],nr:i,side:s.Left},this.table[0][4]={cellType:"movingPill",color:t[1],nr:i,side:s.Right};for(var e,o=r([],this.types,!0),l=0;l<2;l++)e=Math.floor(Math.random()*o.length),this.nextColors[l]=o[e];this.noGame=!1,this.ui.preparePill(this.nextColors)},i.prototype.dropPill=function(){var t=[];if(this.pillPosition){for(var i=0;i<this.pillPosition.length;i++){var e=this.pillPosition[i],s=e.y,o=e.x;if(s>=this.height-1)return void this.preparePill();if(!["none","movingPill"].includes(this.table[s+1][o].cellType))return void this.preparePill();t.push({old:{x:o,y:s},new:{x:o,y:s+1},cell:this.table[s][o]})}this.lastPillPosition=r([],this.pillPosition,!0),this.pillPosition.splice(0,this.pillPosition.length);for(var l=0,n=t;l<n.length;l++){var p=n[l];this.table[p.old.y][p.old.x]=this.emptyCell()}for(var a=0,h=t;a<h.length;a++)p=h[a],this.table[p.new.y][p.new.x]=p.cell,this.pillPosition.push({x:p.new.x,y:p.new.y})}},i.prototype.dropAll=function(){for(var t=[],i=this.height-1;i>=0;i--)for(var e=0;e<this.width;e++){var s=this.table[i][e];"pill"===s.cellType&&i+1<this.height&&"none"===this.table[i+1][e].cellType&&(e+1<this.width?this.table[i][e+1].nr===s.nr?("none"===this.table[i+1][e+1].cellType&&(t.push({old:{x:e,y:i},new:{x:e,y:i+1},cell:this.table[i][e]}),t.push({old:{x:e+1,y:i},new:{x:e+1,y:i+1},cell:this.table[i][e+1]})),e++):(0===e&&this.table[i][e+1].nr!=s.nr||e-1>=0&&this.table[i][e-1].nr!=s.nr)&&t.push({old:{x:e,y:i},new:{x:e,y:i+1},cell:this.table[i][e]}):e===this.width-1&&this.table[i][e-1].nr!=s.nr&&t.push({old:{x:e,y:i},new:{x:e,y:i+1},cell:this.table[i][e]}))}for(var o=0,l=t;o<l.length;o++){var n=l[o];this.table[n.old.y][n.old.x]=this.emptyCell()}for(var p=0,r=t;p<r.length;p++)n=r[p],this.table[n.new.y][n.new.x]=n.cell},i.prototype.movePill=function(){var i=[];if(t.get("a"))for(var e=0;e<this.pillPosition.length;e++){var o=this.pillPosition[e].x,l=this.pillPosition[e].y;(o-1>0&&["none","movingPill"].includes(this.table[l][o-1].cellType)||o-1>=0&&"none"===this.table[l][o-1].cellType)&&i.push({old:{x:o,y:l},new:{y:l,x:o-1},cell:this.table[l][o]})}if(t.get("d"))for(e=0;e<this.pillPosition.length;e++)o=this.pillPosition[e].x,l=this.pillPosition[e].y,(o<this.width-2&&["none","movingPill"].includes(this.table[l][o+1].cellType)||o<this.width-1&&"none"===this.table[l][o+1].cellType)&&i.push({old:{x:o,y:l},new:{y:l,x:o+1},cell:this.table[l][o]});if((t.get("q")||t.get("w"))&&(o=this.pillPosition[0].x,l=this.pillPosition[0].y,this.pillPosition[0].y===this.pillPosition[1].y&&l-1>0&&"none"===this.table[l-1][o].cellType?(this.table[l][o].side=s.Bottom,this.table[this.pillPosition[1].y][this.pillPosition[1].x].side=s.Top,i.push({old:{x:o,y:l},new:{y:l,x:o},cell:this.table[l][o]}),i.push({old:{x:this.pillPosition[1].x,y:this.pillPosition[1].y},new:{y:l-1,x:o},cell:this.table[this.pillPosition[1].y][this.pillPosition[1].x]})):this.pillPosition[0].x===this.pillPosition[1].x&&o+1<this.width&&"none"===this.table[l][o+1].cellType&&(this.table[this.pillPosition[1].y][this.pillPosition[1].x].side=s.Left,this.table[l][o].side=s.Right,i.push({old:{x:this.pillPosition[1].x,y:this.pillPosition[1].y},new:{y:l,x:o},cell:this.table[this.pillPosition[1].y][this.pillPosition[1].x]}),i.push({old:{x:o,y:l},new:{y:l,x:o+1},cell:this.table[l][o]}))),t.get("e")&&(o=this.pillPosition[0].x,l=this.pillPosition[0].y,this.pillPosition[0].y===this.pillPosition[1].y&&l-1>0&&"none"===this.table[l-1][o].cellType?(this.table[l][o].side=s.Bottom,this.table[this.pillPosition[1].y][this.pillPosition[1].x].side=s.Top,i.push({old:{x:o,y:l},new:{y:l,x:o},cell:this.table[l][o]}),i.push({old:{x:this.pillPosition[1].x,y:this.pillPosition[1].y},new:{y:l-1,x:o},cell:this.table[this.pillPosition[1].y][this.pillPosition[1].x]})):this.pillPosition[0].x===this.pillPosition[1].x&&o-1>=0&&"none"===this.table[l][o-1].cellType&&(this.table[this.pillPosition[1].y][this.pillPosition[1].x].side=s.Right,this.table[l][o].side=s.Left,i.push({old:{x:this.pillPosition[1].x,y:this.pillPosition[1].y},new:{y:l,x:o},cell:this.table[this.pillPosition[1].y][this.pillPosition[1].x]}),i.push({old:{x:o,y:l},new:{y:l,x:o-1},cell:this.table[l][o]}))),2===i.length){this.pillPosition.splice(0,this.pillPosition.length);for(var n=0,p=i;n<p.length;n++){var r=p[n];this.table[r.old.y][r.old.x]=this.emptyCell()}for(var a=0,h=i;a<h.length;a++)r=h[a],this.table[r.new.y][r.new.x]=r.cell,this.pillPosition.push({x:r.new.x,y:r.new.y})}},i.prototype.checkForMaches=function(){for(var t,i,e,s=this.height-1;s>=0;s--){var o=this.table[s];t=0,e="",i=!1;for(var l=0,n=0;n<o.length;n++){if(i=!0,"microbe"===(r=o[n]).cellType&&++l,["pill","microbe"].includes(r.cellType)){if(e===r.color&&(i=!1,t++,n<o.length-1))continue;e=r.color}else e="";if(t>=3)if(i){l?this.score+=100*l:this.score-=0,this.microbesNr-=l;for(var p=n-1;p>=n-1-t;p--)this.ui.destroyPill(this.table[s][p].color,s,p),this.table[s][p]=this.emptyCell()}else if(n===o.length-1)for(l?this.score+=100*l:this.score-=0,this.microbesNr-=l,p=n;p>=n-t;p--)this.ui.destroyPill(this.table[s][p].color,s,p),this.table[s][p]=this.emptyCell();t=0}}for(p=0;p<this.width;p++){for(t=0,e="",l=0,n=this.height-1;n>=0;n--){var r;if(i=!0,"microbe"===(r=this.table[n][p]).cellType&&++l,["pill","microbe"].includes(r.cellType)){if(e===r.color&&(i=!1,t++,n>0))continue;e=r.color}else e="";if(t>=3)if(i)for(l?this.score+=100*l:this.score-=0,this.microbesNr-=l,s=n+1;s<=n+1+t;s++)this.ui.destroyPill(this.table[s][p].color,s,p),this.table[s][p]=this.emptyCell();else if(0===n&&t>=3)for(l?this.score+=100*l:this.score-=0,this.microbesNr-=l,s=0;s<=t;s++)this.ui.destroyPill(this.table[s][p].color,s,p),this.table[s][p]=this.emptyCell();t=0}this.ui.setScore(this.score),this.ui.setMicrobesLeft(this.microbesNr)}},i.prototype.checkEndTheGame=function(){var t;this.pillPosition&&this.lastPillPosition&&0===this.microbesNr&&(this.score>this.bestScore&&(this.bestScore=this.score,t=this.score,localStorage.setItem("bestScore",JSON.stringify(t))),cancelAnimationFrame(this.animationFrame),this.ui.stageCleared())},i}();document.addEventListener("keydown",(function(i){t.set(i.key,!0)})),document.addEventListener("keyup",(function(i){t.set(i.key,!1)})),new a})();